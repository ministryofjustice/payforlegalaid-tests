name: Build and test
on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, synchronize]
  repository_dispatch:
    types: [ trigger-tests ]

jobs:
  run_tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub repository
        uses: actions/checkout@v4
        with:
          path: testCode
#
      - name: Build test dependencies
        run: |
          cd testCode
          mvn -B clean compile
          echo "THIS IS THE TEST VERSION OF OPENAPI"
          mvn dependency:tree

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '17'

#      - name: Checkout openapi spec
#        uses: actions/checkout@v4
##        THIS IS THE ISSUE, IT'S DOING CHECKOUT RATHER THAN GETTING A PACKAGE
#        with:
#          repository: ministryofjustice/payforlegalaid-openapi
#          path: openapi
#          ssh-key: ${{ secrets.DEPLOY_KEY_OPENAPI }}
##          ref: refs/tags/v + pom thing 0.0.2
#
#      - name: Build openapi spec dependency
#        run: |
#          cd openapi
#          mvn -B clean install
#
#          echo "THIS IS THE INSTALL VERSION OF OPENAPI"
#          mvn dependency:tree
          

      - name: Checkout source code repo
        uses: actions/checkout@v4
        with:
          repository: ministryofjustice/payforlegalaid
          path: sourceCode
          ref: 2e29e149fd3674dd32b90f389b937b37e90dc232

      - name: Build source code
        run: |
          cd sourceCode
          mvn -B -DskipTests clean install -Dpayforlegalaid-openapi.version=0.0.3
          echo "THIS ARE THE MAIN APP DEPENDENCIES"
          mvn dependency:tree

      - name: Run tests
        run: |
          cd testCode
          mvn -B clean compile
          echo "THIS ARE THE TEST APP DEPENDENCIES"
          mvn dependency:tree
          mvn test -s .github/settings.xml

        shell:
          bash
